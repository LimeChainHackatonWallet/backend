<!DOCTYPE html>
<html>
<head>
  <title>Solana Wallet Tester</title>
  <!-- Update this import to load SimpleWebAuthnBrowser correctly -->
  <script src="https://unpkg.com/@simplewebauthn/browser/dist/bundle/index.umd.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
    .section { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
    button { margin: 5px; padding: 8px 12px; }
    pre { background: #f4f4f4; padding: 10px; border-radius: 5px; overflow: auto; }
  </style>
</head>
<body>
  <h1>Solana Wallet Tester</h1>
  
  <div class="section">
    <h2>Authentication</h2>
    <input id="username" placeholder="Username" />
    <button id="register">Register</button>
    <button id="login">Login</button>
    <div id="auth-status"></div>
  </div>
  
  <div class="section">
    <h2>Wallet Operations</h2>
    <button id="get-wallet">Get Wallet Info</button>
    <button id="airdrop">Request Airdrop (1 SOL)</button>
    
    <div>
      <h3>Transfer SOL</h3>
      <input id="recipient" placeholder="Recipient Address" style="width: 350px;" />
      <input id="amount" placeholder="Amount" type="number" step="0.01" value="0.1" style="width: 100px;" />
      <button id="transfer">Transfer</button>
    </div>
    
    <div>
      <h3>Sign Message</h3>
      <input id="message" placeholder="Message to sign" value="Hello, Solana!" style="width: 300px;" />
      <button id="sign">Sign</button>
    </div>
  </div>
  
  <div class="section">
    <h2>Results</h2>
    <pre id="result">No results yet</pre>
  </div>
  
  <script>
    const API_URL = 'http://localhost:3000/api';
    const resultElement = document.getElementById('result');
    const authStatus = document.getElementById('auth-status');
    
    // Check if we're already logged in
    const token = localStorage.getItem('token');
    const storedUsername = localStorage.getItem('username');
    
    if (token && storedUsername) {
      authStatus.textContent = `Logged in as: ${storedUsername}`;
      document.getElementById('username').value = storedUsername;
    } else {
      authStatus.textContent = 'Not logged in';
    }
    
    // Helper function for API calls
    async function apiCall(endpoint, body, needsAuth = false) {
      const headers = { 'Content-Type': 'application/json' };
      
      if (needsAuth) {
        const token = localStorage.getItem('token');
        if (!token) {
          throw new Error('Not authenticated. Please login first.');
        }
        headers['Authorization'] = `Bearer ${token}`;
      }
      console.log('API URL:', `${API_URL}${endpoint}`);
      const response = await fetch(`${API_URL}${endpoint}`, {
        method: 'POST',
        headers,
        body: JSON.stringify(body)
      });
      
      return response.json();
    }
    
    // Register
    document.getElementById('register').addEventListener('click', async () => {
      const username = document.getElementById('username').value;
      if (!username) {
        resultElement.textContent = 'Please enter a username';
        return;
      }
      
      try {
        // 1. Get registration options
        const options = await apiCall('/auth/register', { username });
        resultElement.textContent = JSON.stringify(options, null, 2);
        
        if (!options.success) {
          throw new Error(options.message);
        }
        
        // 2. Start WebAuthn registration
        // Use correct reference to SimpleWebAuthnBrowser
        const registrationResponse = await SimpleWebAuthnBrowser.startRegistration(options.data);
        
        // 3. Verify registration
        const verification = await apiCall('/auth/register/verify', {
          username,
          registrationResponse
        });
        
        resultElement.textContent = JSON.stringify(verification, null, 2);
        
        if (verification.success) {
          alert('Registration successful! You can now login.');
        }
      } catch (error) {
        resultElement.textContent = error.message;
      }
    });
    
    // Login
    document.getElementById('login').addEventListener('click', async () => {
      const username = document.getElementById('username').value;
      if (!username) {
        resultElement.textContent = 'Please enter a username';
        return;
      }
      
      try {
        // 1. Get authentication options
        const options = await apiCall('/auth/login', { username });
        resultElement.textContent = JSON.stringify(options, null, 2);
        
        if (!options.success) {
          throw new Error(options.message);
        }
        
        // 2. Start WebAuthn authentication
        // Use correct reference to SimpleWebAuthnBrowser
        const authenticationResponse = await SimpleWebAuthnBrowser.startAuthentication(options.data);
        
        // 3. Verify authentication
        const verification = await apiCall('/auth/login/verify', {
          username,
          authenticationResponse
        });
        
        resultElement.textContent = JSON.stringify(verification, null, 2);
        
        if (verification.success) {
          localStorage.setItem('token', verification.token);
          localStorage.setItem('username', verification.username);
          authStatus.textContent = `Logged in as: ${verification.username}`;
          alert('Login successful!');
        }
      } catch (error) {
        resultElement.textContent = error.message;
      }
    });
    
    // Get Wallet Info
    document.getElementById('get-wallet').addEventListener('click', async () => {
      const username = localStorage.getItem('username');
      if (!username) {
        resultElement.textContent = 'Please login first';
        return;
      }
      
      try {
        const result = await apiCall('/wallet/info', { username }, true);
        resultElement.textContent = JSON.stringify(result, null, 2);
      } catch (error) {
        resultElement.textContent = error.message;
      }
    });
    
    // Request Airdrop
    document.getElementById('airdrop').addEventListener('click', async () => {
      const username = localStorage.getItem('username');
      if (!username) {
        resultElement.textContent = 'Please login first';
        return;
      }
      
      try {
        const result = await apiCall('/wallet/airdrop', { username, amount: 1 }, true);
        resultElement.textContent = JSON.stringify(result, null, 2);
      } catch (error) {
        resultElement.textContent = error.message;
      }
    });
    
    // Transfer SOL
    document.getElementById('transfer').addEventListener('click', async () => {
      const username = localStorage.getItem('username');
      const recipient = document.getElementById('recipient').value;
      const amount = parseFloat(document.getElementById('amount').value);
      
      if (!username) {
        resultElement.textContent = 'Please login first';
        return;
      }
      
      if (!recipient || !amount) {
        resultElement.textContent = 'Please enter recipient and amount';
        return;
      }
      
      try {
        const result = await apiCall('/wallet/transfer', { 
          username, 
          recipient, 
          amount 
        }, true);
        resultElement.textContent = JSON.stringify(result, null, 2);
      } catch (error) {
        resultElement.textContent = error.message;
      }
    });
    
    // Sign Message
    document.getElementById('sign').addEventListener('click', async () => {
      const username = localStorage.getItem('username');
      const message = document.getElementById('message').value;
      
      if (!username) {
        resultElement.textContent = 'Please login first';
        return;
      }
      
      if (!message) {
        resultElement.textContent = 'Please enter a message to sign';
        return;
      }
      
      try {
        const result = await apiCall('/wallet/sign', { 
          username, 
          message 
        }, true);
        resultElement.textContent = JSON.stringify(result, null, 2);
      } catch (error) {
        resultElement.textContent = error.message;
      }
    });
  </script>
</body>
</html>